<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê± Kawaii Blackjack ‚ú®</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard', cursive, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            text-align: center;
            background: linear-gradient(135deg, #fff5f5 0%, #fff0f6 50%, #f5f0ff 100%);
            min-height: 100vh;
            color: #6b5b7a;
        }
        
        h1 {
            color: #ff85a2;
            text-shadow: 3px 3px 0px #ffd1dc;
            font-size: 2.5em;
            margin-bottom: 10px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        h3 { color: #b8a9c9; }
        h4 { color: #f9a8d4; margin-bottom: 15px; }
        
        .section {
            margin: 25px auto;
            padding: 25px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.4);
            max-width: 90%;
            border: 3px solid #ffd1dc;
        }
        
        button {
            padding: 12px 25px;
            margin: 8px;
            font-size: 16px;
            cursor: pointer;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
            border: none;
            border-radius: 50px;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 154, 158, 0.4);
            font-family: inherit;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 15px rgba(255, 154, 158, 0.6);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        input {
            padding: 12px;
            font-size: 16px;
            width: 220px;
            border: 3px solid #ffd1dc;
            border-radius: 50px;
            text-align: center;
            font-family: inherit;
        }
        
        input:focus {
            outline: none;
            border-color: #ff9a9e;
            box-shadow: 0 0 12px rgba(255, 154, 158, 0.3);
        }
        
        /* Card styles - much smaller font */
        .cards-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
            min-height: 100px;
            align-items: center;
        }
        
        .card {
            width: 60px;
            height: 90px;
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid #f8e8e8;
        }
        
        .card:hover {
            transform: translateY(-3px) rotate(1deg);
        }
        
        .card.red {
            color: #ff6b9d;
            border-color: #ffb6c1;
        }
        
        .card.black {
            color: #5a4a7a;
            border-color: #d4c5e8;
        }
        
        .card .corner {
            position: absolute;
            font-size: 10px;
        }
        
        .card .corner-top {
            top: 4px;
            left: 5px;
        }
        
        .card .corner-bottom {
            bottom: 4px;
            right: 5px;
            transform: rotate(180deg);
        }
        
        .card .center {
            font-size: 20px;
        }
        
        .score {
            font-size: 16px;
            color: #9b8ab0;
            font-weight: bold;
            margin-top: 6px;
        }
        
        .result {
            font-size: 24px;
            font-weight: bold;
            color: #ff85a2;
            margin: 18px 0;
            animation: sparkle 1s ease-in-out infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .hidden {
            display: none !important;
        }
        
        .card-back {
            background: linear-gradient(135deg, #ff9a9e 25%, #fecfef 25%, #fecfef 50%, #ff9a9e 50%, #ff9a9e 75%, #fecfef 75%);
            background-size: 12px 12px;
            font-size: 18px !important;
        }
        
        .card-back::after {
            content: "üêæ";
        }
        
        #playerIdDisplay {
            color: #ff85a2;
            font-weight: bold;
            font-size: 16px;
            margin-top: 12px;
        }
        
        #gameIdDisplay {
            font-weight: bold;
            color: #ff6b9d;
        }
        
        /* Stats styles - Table format */
        .stats-table {
            width: 100%;
            max-width: 350px;
            margin: 15px auto;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        
        .stats-table th {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 14px;
        }
        
        .stats-table td {
            background: #fff9fb;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 16px;
            color: #6b5b7a;
            border: 2px solid #ffd1dc;
        }
        
        .stats-table td:first-child {
            font-weight: bold;
            color: #ff85a2;
        }
        
        .stats-table tr:hover td {
            background: #fff0f6;
        }
        
        /* Win rate bar */
        .winrate-container {
            max-width: 350px;
            margin: 15px auto;
        }
        
        .winrate-text {
            font-size: 16px;
            font-weight: bold;
            color: #ff85a2;
            margin-bottom: 10px;
        }
        
        .winrate-bar {
            background: #ffeef2;
            border-radius: 20px;
            height: 24px;
            overflow: hidden;
            border: 2px solid #ffd1dc;
        }
        
        .winrate-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9a9e, #fecfef);
            border-radius: 20px;
            transition: width 0.5s ease;
        }
        
        /* History table */
        .history-table {
            width: 100%;
            max-width: 550px;
            margin: 15px auto;
            border-collapse: separate;
            border-spacing: 0 6px;
        }
        
        .history-table th {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            color: white;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .history-table td {
            background: white;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 13px;
            color: #6b5b7a;
            border: 2px solid #f0e8f8;
        }
        
        .history-table tr:hover td {
            background: #f8f0ff;
        }
        
        .history-result.win {
            color: #84fab0;
            font-weight: bold;
        }
        
        .history-result.loss {
            color: #ff9a9e;
            font-weight: bold;
        }
        
        .history-result.push {
            color: #f6d365;
            font-weight: bold;
        }
        
        .history-win { border-left: 4px solid #84fab0; }
        .history-loss { border-left: 4px solid #ff9a9e; }
        .history-push { border-left: 4px solid #f6d365; }
        
        .history-title {
            color: #b8a9c9;
            margin: 20px 0 10px 0;
            font-size: 18px;
        }
        
        /* Dealer thinking indicator */
        .dealer-thinking {
            font-size: 14px;
            color: #ff9a9e;
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>üê± Kawaii Blackjack ‚ú®</h1>
    <div style="font-size: 20px; margin-bottom: 15px;">Good Luck, Kitty! üçÄ</div>
    
    <div class="section">
        <h3>üå∏ Login / Register üå∏</h3>
        <input type="text" id="playerName" placeholder="Enter your name">
        <button onclick="loginOrCreate()">üê± Enter</button>
        <div id="playerInfo" class="hidden">
            <p id="playerIdDisplay"></p>
            
            <!-- Stats table -->
            <table class="stats-table">
                <tr>
                    <th>üèÜ Wins</th>
                    <td id="statWins">0</td>
                </tr>
                <tr>
                    <th>üíî Losses</th>
                    <td id="statLosses">0</td>
                </tr>
                <tr>
                    <th>ü§ù Pushes</th>
                    <td id="statPushes">0</td>
                </tr>
            </table>
            
            <!-- Win rate -->
            <div class="winrate-container">
                <div class="winrate-text">Win Rate: <span id="winRateDisplay">0%</span> ‚ú®</div>
                <div class="winrate-bar">
                    <div class="winrate-fill" id="winRateFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Game History -->
            <h4 class="history-title">üìú Game History</h4>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Result</th>
                        <th>Your Score</th>
                        <th>Dealer Score</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="historyList">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999;">No games yet üê±</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="section hidden" id="startSection">
        <h3>üéØ Start Game</h3>
        <button onclick="startGame()">üÉè New Game</button>
    </div>
    
    <div class="section hidden" id="gameSection">
        <h3>üé∞ Game in Progress</h3>
        <p>Game ID: <span id="gameIdDisplay"></span></p>
        <div class="section">
            <h4>üÉè Your Hand</h4>
            <div class="cards-container" id="playerCards"></div>
            <div class="score">Score: <span id="playerScore"></span></div>
        </div>
        <div class="section">
            <h4>üé∞ Dealer's Hand <span id="dealerIndicator" class="dealer-thinking hidden">üé≤ Dealer playing...</span></h4>
            <div class="cards-container" id="dealerCards"></div>
            <div class="score">Score: <span id="dealerScore"></span></div>
        </div>
        <div id="resultDisplay"></div>
        <button onclick="window.standFunction()" id="btnStand">‚úã Stand</button>
        <button onclick="window.hitFunction()" id="btnHit">üÉè Hit</button>
        <button onclick="newGame()" id="btnNewGame" class="hidden">üîÑ New Game</button>
        <button onclick="deleteGame()" id="btnDelete">üóëÔ∏è Delete</button>
    </div>
    
    <script>
        console.log("=== KAWAII BLACKJACK JS LOADED v6 ===" + new Date().toISOString());
        let currentPlayerId = null;
        let currentGameId = null;
        
        window.crupierTurnStarted = false;
        let crupierPlayTimeout = null;
        
        // Map backend suit names to emojis and display symbols
        const suitMap = {
            'HEARTS': { emoji: '‚ô•Ô∏è', symbol: '‚ô•', isRed: true },
            'DIAMONDS': { emoji: '‚ô¶Ô∏è', symbol: '‚ô¶', isRed: true },
            'SPADES': { emoji: '‚ô†Ô∏è', symbol: '‚ô†', isRed: false },
            'CLUBS': { emoji: '‚ô£Ô∏è', symbol: '‚ô£', isRed: false },
            '‚ô•': { emoji: '‚ô•Ô∏è', symbol: '‚ô•', isRed: true },
            '‚ô¶': { emoji: '‚ô¶Ô∏è', symbol: '‚ô¶', isRed: true },
            '‚ô†': { emoji: '‚ô†Ô∏è', symbol: '‚ô†', isRed: false },
            '‚ô£': { emoji: '‚ô£Ô∏è', symbol: '‚ô£', isRed: false }
        };
        
        // Map rank display names
        const rankDisplayMap = {
            'TWO': '2', 'THREE': '3', 'FOUR': '4', 'FIVE': '5',
            'SIX': '6', 'SEVEN': '7', 'EIGHT': '8', 'NINE': '9',
            'TEN': '10', 'JACK': 'J', 'QUEEN': 'Q', 'KING': 'K', 'ACE': 'A'
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const btnStand = document.getElementById('btnStand');
            if (btnStand) {
                btnStand.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.standFunction();
                });
            }
            
            const btnHit = document.getElementById('btnHit');
            if (btnHit) {
                btnHit.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.hitFunction();
                });
            }
        });
        
        window.standFunction = async function() {
            if (!currentGameId) {
                alert("No active game");
                return;
            }
            
            try {
                const response = await fetch("/games/" + currentGameId + "/stand", { method: "POST" });
                
                if (response.ok) {
                    const game = await response.json();
                    updateGameDisplay(game);
                } else if (response.status === 400) {
                    const error = await response.json();
                    document.getElementById("resultDisplay").innerHTML = "<div class=\"result\" style=\"color: #ff6b9d\">" + (error.message || "Cannot stand now") + "</div>";
                } else {
                    alert("Error standing: " + response.status);
                }
            } catch (error) {
                console.error("Stand exception:", error);
                alert("Connection error while standing");
            }
        };
        
        window.hitFunction = async function() {
            if (!currentGameId) {
                alert("No active game");
                return;
            }
            
            const btnHit = document.getElementById("btnHit");
            const btnStand = document.getElementById("btnStand");
            if (btnHit) btnHit.disabled = true;
            if (btnStand) btnStand.disabled = true;
            
            try {
                const response = await fetch("/games/" + currentGameId + "/hit", { method: "POST" });
                
                if (response.ok) {
                    const game = await response.json();
                    updateGameDisplay(game);
                    
                    if (game.result && game.result !== "NO_RESULTS_YET") {
                        loginOrCreate();
                    }
                } else {
                    if (btnHit) btnHit.disabled = false;
                    if (btnStand) btnStand.disabled = false;
                }
            } catch (error) {
                console.error("Hit exception:", error);
                if (btnHit) btnHit.disabled = false;
                if (btnStand) btnStand.disabled = false;
            }
        };
        
        async function loginOrCreate() {
            const name = document.getElementById("playerName").value;
            if (!name) return alert("Please enter your name");
            
            const response = await fetch("/players/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name })
            });
            
            if (response.ok) {
                const player = await response.json();
                currentPlayerId = player.id;
                
                document.getElementById("playerIdDisplay").innerHTML = "üë§ " + player.name + " (ID: " + player.id + ") üê±";
                
                document.getElementById("statWins").textContent = player.wins;
                document.getElementById("statLosses").textContent = player.losses;
                document.getElementById("statPushes").textContent = player.pushes;
                
                updateWinRate(player.wins, player.losses, player.pushes);
                loadPlayerStats();
                
                document.getElementById("playerInfo").classList.remove("hidden");
                document.getElementById("startSection").classList.remove("hidden");
            }
        }
        
        function updateWinRate(wins, losses, pushes) {
            const total = wins + losses + pushes;
            const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
            document.getElementById("winRateDisplay").textContent = winRate + "%";
            document.getElementById("winRateFill").style.width = winRate + "%";
        }
        
        async function loadPlayerStats() {
            if (!currentPlayerId) return;
            
            try {
                const response = await fetch("/players/" + currentPlayerId + "/stats");
                if (response.ok) {
                    const stats = await response.json();
                    console.log("Stats loaded:", stats);
                    document.getElementById("statWins").textContent = stats.wins;
                    document.getElementById("statLosses").textContent = stats.losses;
                    document.getElementById("statPushes").textContent = stats.pushes;
                    updateWinRate(stats.wins, stats.losses, stats.pushes);
                    updateHistoryTable(stats.recentGames || []);
                } else {
                    console.log("Stats endpoint returned:", response.status);
                }
            } catch (error) {
                console.log("Could not load stats:", error.message);
            }
        }
        
        function updateHistoryTable(recentGames) {
            const historyList = document.getElementById("historyList");
            
            console.log("Updating history table with:", recentGames);
            
            if (!recentGames || recentGames.length === 0) {
                historyList.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No games yet üê±</td></tr>';
                return;
            }
            
            const historyHtml = recentGames.map(function(game) {
                let resultClass = "";
                let resultText = "";
                
                if (game.result === "PLAYER_WINS") {
                    resultClass = "history-win";
                    resultText = "Win üèÜ";
                } else if (game.result === "CRUPIER_WINS") {
                    resultClass = "history-loss";
                    resultText = "Loss ‚ùå";
                } else {
                    resultClass = "history-push";
                    resultText = "Push ü§ù";
                }
                
                // Format date - backend sends "MMM d, HH:mm" format
                let dateStr = "Recently";
                if (game.playedAt && game.playedAt !== "N/A") {
                    try {
                        dateStr = game.playedAt; // Already formatted by backend
                    } catch (e) {
                        dateStr = "Recently";
                    }
                }
                
                return '<tr class="' + resultClass + '">' +
                    '<td><span class="history-result ' + (game.result === "PLAYER_WINS" ? "win" : (game.result === "CRUPIER_WINS" ? "loss" : "push")) + '">' + resultText + '</span></td>' +
                    '<td>' + game.playerScore + '</td>' +
                    '<td>' + game.dealerScore + '</td>' +
                    '<td>' + dateStr + '</td>' +
                    '</tr>';
            }).join("");
            
            historyList.innerHTML = historyHtml;
        }
        
        async function startGame() {
            if (!currentPlayerId) return alert("Please create a player first");
            
            // Clear any existing timeout
            if (crupierPlayTimeout) {
                clearTimeout(crupierPlayTimeout);
                crupierPlayTimeout = null;
            }
            window.crupierTurnStarted = false;
            
            const response = await fetch("/games/new", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ playerId: currentPlayerId })
            });
            if (response.ok) {
                const game = await response.json();
                currentGameId = game.id;
                document.getElementById("gameIdDisplay").textContent = game.id;
                document.getElementById("gameSection").classList.remove("hidden");
                updateGameDisplay(game);
            }
        }
        
        async function hit() { return window.hitFunction(); }
        async function stand() { return window.standFunction(); }
        
        async function newGame() {
            if (crupierPlayTimeout) {
                clearTimeout(crupierPlayTimeout);
                crupierPlayTimeout = null;
            }
            window.crupierTurnStarted = false;
            
            document.getElementById("btnHit").classList.remove("hidden");
            document.getElementById("btnStand").classList.remove("hidden");
            document.getElementById("btnNewGame").classList.add("hidden");
            document.getElementById("resultDisplay").innerHTML = "";
            document.getElementById("dealerIndicator").classList.add("hidden");
            startGame();
        }
        
        async function deleteGame() {
            if (!currentGameId) return;
            
            if (crupierPlayTimeout) {
                clearTimeout(crupierPlayTimeout);
                crupierPlayTimeout = null;
            }
            
            const btnDelete = document.getElementById("btnDelete");
            btnDelete.disabled = true;
            btnDelete.textContent = "Deleting...";
            
            try {
                const response = await fetch("/games/" + currentGameId + "/delete", { method: "DELETE" });
                
                if (response.ok) {
                    currentGameId = null;
                    document.getElementById("gameSection").classList.add("hidden");
                } else {
                    alert("Error deleting game");
                }
            } catch (error) {
                alert("Error deleting game: " + error.message);
            } finally {
                btnDelete.disabled = false;
                btnDelete.textContent = "üóëÔ∏è Delete";
            }
        }
        
        function createCardElement(card) {
            console.log("Creating card from:", card);
            
            // Handle different possible card formats from backend
            let rank = card.rank || 'A';
            let suit = card.suit || 'SPADES';
            
            // Get suit info from map
            const suitInfo = suitMap[suit.toUpperCase()] || suitMap['SPADES'];
            const isRed = suitInfo.isRed;
            const suitEmoji = suitInfo.emoji;
            
            // Get display rank
            const rankDisplay = rankDisplayMap[rank.toUpperCase()] || rank.charAt(0);
            
            return '<div class="card ' + (isRed ? 'red' : 'black') + '">' +
                '<span class="corner corner-top">' + rankDisplay + '</span>' +
                '<span class="center">' + suitEmoji + '</span>' +
                '<span class="corner corner-bottom">' + rankDisplay + '</span>' +
                '</div>';
        }
        
        function updateGameDisplay(game) {
            console.log("Updating game display:", game);
            
            document.getElementById("resultDisplay").innerHTML = "";
            
            // Update player cards
            const playerCardsHtml = game.player.hand.map(function(c) { return createCardElement(c); }).join("");
            document.getElementById("playerCards").innerHTML = playerCardsHtml;
            document.getElementById("playerScore").textContent = game.player.score;
            
            // Update dealer cards
            const dealerCardsHtml = game.crupierHand.map(function(c) { return createCardElement(c); }).join("");
            document.getElementById("dealerCards").innerHTML = dealerCardsHtml;
            document.getElementById("dealerScore").textContent = game.crupierScore;
            
            // Show dealer indicator when it's dealer's turn
            const dealerIndicator = document.getElementById("dealerIndicator");
            if (game.status === "CRUPIER_TURN") {
                dealerIndicator.classList.remove("hidden");
            } else {
                dealerIndicator.classList.add("hidden");
            }
            
            // Handle dealer's turn
            if (game.status === "CRUPIER_TURN" && !window.crupierTurnStarted) {
                window.crupierTurnStarted = true;
                crupierPlayStep();
            } else if (game.status !== "CRUPIER_TURN") {
                window.crupierTurnStarted = false;
            }
            
            const btnHit = document.getElementById("btnHit");
            const btnStand = document.getElementById("btnStand");
            const btnNewGame = document.getElementById("btnNewGame");
            
            const isFinalResult = game.result && game.result !== "NO_RESULTS_YET";
            
            if (isFinalResult) {
                // Hide dealer indicator when game is finished
                dealerIndicator.classList.add("hidden");
                window.crupierTurnStarted = false;
                if (crupierPlayTimeout) {
                    clearTimeout(crupierPlayTimeout);
                    crupierPlayTimeout = null;
                }
                
                const resultMap = {
                    "PLAYER_WINS": "YOU WIN! üéâ üê±",
                    "CRUPIER_WINS": "YOU LOSE üòî",
                    "PUSH": "PUSH ü§ù",
                    "BLACKJACK": "BLACKJACK! üèÜ ‚ú®"
                };
                const displayResult = resultMap[game.result] || game.result;
                const colors = {
                    "YOU WIN! üéâ üê±": "#84fab0",
                    "YOU LOSE üòî": "#ff9a9e",
                    "PUSH ü§ù": "#f6d365",
                    "BLACKJACK! üèÜ ‚ú®": "#a18cd1"
                };
                document.getElementById("resultDisplay").innerHTML = "<div class=\"result\" style=\"color: " + colors[displayResult] + "\">" + displayResult + "</div>";
                
                btnHit.classList.add("hidden");
                btnStand.classList.add("hidden");
                btnNewGame.classList.remove("hidden");
                
                btnHit.disabled = true;
                btnStand.disabled = true;
            } else {
                const playerStatus = game.player.status;
                const canHit = playerStatus === "ACTIVE";
                const canStand = playerStatus === "ACTIVE";
                
                btnHit.classList.remove("hidden");
                btnStand.classList.remove("hidden");
                btnNewGame.classList.add("hidden");
                
                btnHit.disabled = !canHit;
                btnStand.disabled = !canStand;
            }
        }
        
        function crupierPlayStep() {
            if (!currentGameId) return;
            if (window.crupierTurnStarted === false) return;
            
            console.log("Dealer playing... gameId:", currentGameId);
            
            crupierPlayTimeout = setTimeout(async function() {
                try {
                    const response = await fetch("/games/" + currentGameId + "/crupier-hit", {
                        method: "POST"
                    });
                    
                    if (response.ok) {
                        const game = await response.json();
                        updateGameDisplay(game);
                        
                        // If game finished, refresh stats
                        if (game.status === "FINISHED" && game.result && game.result !== "NO_RESULTS_YET") {
                            loginOrCreate();
                        }
                        
                        // If dealer still needs to play, continue
                        if (game.status === "CRUPIER_TURN") {
                            crupierPlayStep();
                        }
                    } else {
                        console.error("Dealer hit failed:", response.status);
                    }
                } catch (error) {
                    console.error("Dealer hit exception:", error);
                }
            }, 800); // 800ms delay between dealer cards
        }
    </script>
</body>
</html>
